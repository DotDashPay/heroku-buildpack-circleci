#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

CIRCLECI_TOKEN=`cat $ENV_DIR/CIRCLECI_TOKEN`
CIRCLECI_PROJECT=`cat $ENV_DIR/CIRCLECI_PROJECT`
CIRCLECI_ARTIFACT=`cat $ENV_DIR/CIRCLECI_ARTIFACT`
CIRCLECI_BUILD_NUM=`cat $ENV_DIR/CIRCLECI_BUILD_NUM`
JSON_HEADER='Accept:application/json'

CIRCLECI_BASE_URL='https://circleci.com/api/v1/project'
CIRCLECI_PROJECT_URL="$CIRCLECI_BASE_URL/$CIRCLECI_PROJECT"
BRANCH=`git rev-parse --abbrev-ref HEAD`
CIRCLECI_BUILDS_URL="$CIRCLECI_PROJECT_URL/tree/$BRANCH?circle-token=$CIRCLECI_TOKEN&limit=5"

BUILDS_OUTPUT='builds.json'

CIRCLECI_ARTIFACTS_URL="$CIRCLECI_PROJECT_URL/$CIRCLECI_BUILD_NUM/artifacts?circle-token=$CIRCLECI_TOKEN"

ARTIFACTS_OUTPUT='artifacts.json'


curl --header $JSON_HEADER -o $ARTIFACTS_OUTPUT $CIRCLECI_ARTIFACTS_URL

CIRCLECI_ARTIFACT_URL=`bin/get_artifact $CIRCLECI_ARTIFACT $ARTIFACTS_OUTPUT`
CIRCLECI_ARTIFACT_URL=`echo $CIRCLECI_ARTIFACT_URL | sed -e 's/"//g'`
CIRCLECI_ARTIFACT_URL="$CIRCLECI_ARTIFACT_URL?circle-token=$CIRCLECI_TOKEN"

echo $CIRCLECI_ARTIFACT_URL

echo `curl -k -o "$CIRCLECI_ARTIFACT" $CIRCLECI_ARTIFACT_URL 2>&1`

if [ -e "$CIRCLECI_ARTIFACT" ]
then
  echo "Unzipping the artifact into $BUILD_DIR"
  tar -C $BUILD_DIR -xzf $CIRCLECI_ARTIFACT
  echo `ls $BUILD_DIR`
  rm $CIRCLECI_ARTIFACT
  exit
fi

echo "Did not get the artifact"
exit 1
