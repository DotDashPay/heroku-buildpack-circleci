#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# in the form of "/home/ubuntu/path/to/gzip"
ARTIFACT=`cat $ENV_DIR/CIRCLECI_ARTIFACT`
# the build number you wish to deploy
BUILD_NUMBER=`cat $ENV_DIR/CIRCLECI_BUILD_NUM`
# the build number you wish to deploy
CIRCLE_TOKEN=`cat $ENV_DIR/CIRCLECI_TOKEN`
# the circleci number for the repo. can be found in subdomain of the artifact url.
# (ie https://<build-num>-<repo-num>.gh.circle-artifacts.com)
CIRCLE_REPO_NUM=`cat $ENV_DIR/CIRCLECI_REPO_NUM`
# what we save the tar as, on the host
LOCAL_ARTIFACT="circleci_artifact.tar.gz"
# if we want a non-circleci url
CUSTOM_ARTIFACT_URL=""
if [ -f "$ENV_DIR/CUSTOM_ARTIFACT_URL" ]; then
   CUSTOM_ARTIFACT_URL=`cat $ENV_DIR/CUSTOM_ARTIFACT_URL`
fi

if [ -n "$CUSTOM_ARTIFACT_URL" ]; then
    wget "$CUSTOM_ARTIFACT_URL" -O $LOCAL_ARTIFACT
else
    wget "https://${BUILD_NUMBER}-${CIRCLE_REPO_NUM}-gh.circle-artifacts.com/0${ARTIFACT}?circle-token=${CIRCLE_TOKEN}" -O $LOCAL_ARTIFACT
fi


if [ -e "$LOCAL_ARTIFACT" ]; then
  echo "Unzipping the artifact into $BUILD_DIR/bin"
  mkdir ${BUILD_DIR}/bin
  tar xf $LOCAL_ARTIFACT -C ${BUILD_DIR}/bin
  rm $LOCAL_ARTIFACT
  exit 0
fi

echo "Did not get the artifact"
exit 1
